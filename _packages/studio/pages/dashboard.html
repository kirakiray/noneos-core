<template page>
  <l-m src="/gh/ofajs/Punch-UI/packages/button/button.html"></l-m>
  <l-m src="/gh/ofajs/Punch-UI/packages/input/input.html"></l-m>
  <l-m src="/gh/ofajs/Punch-UI/packages/switch/switch.html"></l-m>
  <l-m src="/nos/n-icon/n-icon.html"></l-m>

  <style>
    :host {
      display: block;
    }

    h3 {
      font-size: 18px;
    }

    .container {
      width: 100%;
      height: 100%;
      padding: 16px;
      box-sizing: border-box;
    }

    .frame-contaner {
      --frame-width: 360px;
      --frame-height: 400px;
      --frame-scale: 0.75;
      width: var(--frame-width);
      height: var(--frame-height);
      border-radius: 4px;
      border: 1px solid var(--md-sys-color-primary);
    }

    .preview-frame {
      width: calc(var(--frame-width) / var(--frame-scale));
      height: calc(var(--frame-height) / var(--frame-scale));
      transform: scale(var(--frame-scale));
      transform-origin: top left;
    }
  </style>
  <div class="container">
    <h3>预览</h3>
    <div class="frame-contaner">
      <iframe
        class="preview-frame"
        attr:src="previewUrl"
        frameborder="0"
      ></iframe>
    </div>
    <div style="padding-top: 16px">
      <p-button variant="outlined">
        <n-icon icon="material-symbols:preview" slot="prefix"></n-icon>
        <a attr:href="previewUrl" target="_blank">新窗口预览应用</a>
      </p-button>
    </div>
    <!-- <h3>更新信息</h3>
    <p-input style="width: 300px">
      <label>项目名</label>
    </p-input>
    <p-button style="margin-top: 16px">
      <n-icon icon="material-symbols:update" slot="prefix"></n-icon>
      更新项目
    </p-button> -->
    <h3>其他功能</h3>
    <p-switch sync:value="studioConfig.useHCT" on:change="changeUseHCT">
      使用HCT色盘
    </p-switch>
  </div>
  <script>
    export const parent = "./layout.html";

    export default async ({ load, query }) => {
      const { get } = await load("/nos/fs/main.js");
      const { createData } = await load("/nos/hybrid-data/main.js");

      return {
        data: {
          previewUrl: "/" + query.path + "/",
          studioConfig: {},
          _rootHandle: null,
        },
        proto: {
          changeUseHCT() {
            const useHCT = this.studioConfig.useHCT === "on";

            if (useHCT) {
              // index添加标签
            }

            debugger;
          },
        },
        async attached() {
          sessionStorage.setItem("currentPath", query.path);

          // 打开目标
          this._rootHandle = await get(query.path);

          // package.json
          const packagejsonHandle = await this._rootHandle.get("package.json");
          this._pgData = await createData(packagejsonHandle);

          // 判断是否有基础配置
          if (!this._pgData.ofaStudio) {
            this._pgData.ofaStudio = {
              useHCT: "off",
            };
          }

          this.studioConfig = this._pgData.ofaStudio;

          this.emit("active-page", {
            composed: true,
            data: {
              name: "dashboard",
            },
          });
        },
        detached() {
          if (this._pgData) {
            this._pgData.disconnect();
          }
        },
      };
    };
  </script>
</template>
