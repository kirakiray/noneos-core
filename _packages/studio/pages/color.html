<template page>
  <style>
    :host {
      display: block;
      height: 100%;
      user-select: none;
    }
    .container {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      padding: 16px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .color-group {
      display: inline-flex;
      align-items: center;
      margin-bottom: 8px;
      border: 1px solid #000000;
    }
    .color-name {
      font-size: 16px;
      font-weight: bold;
      width: 80px;
      padding-left: 16px;
    }

    .color-block {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 100px;
      font-size: 14px;
      cursor: pointer;
    }

    .theme-name {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 16px;
    }

    .theme-container {
      display: inline-block;
      padding: 16px;
      margin-bottom: 16px;
      border-radius: 4px;
    }

    .theme-color-container {
      display: flex;
      flex-wrap: wrap;
    }

    .theme-color-group {
      margin: 0 4px 4px 0;
    }

    .theme-color-block {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
      width: 200px;
      height: 60px;
      font-size: 14px;
      cursor: pointer;
    }

    .theme-color-css-var {
      display: none;
    }

    .theme-color-block:hover .theme-color-css-var {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-color-block:hover .theme-color-name {
      display: none;
    }

    .theme-color-container .theme-color-block:nth-child(2n) {
      margin-bottom: 8px;
    }
  </style>
  <div class="container">
    <h3>组合</h3>
    <o-fill :value="themes">
      <div
        class="theme-container"
        :style.background="$data.surface.color"
        :style.color="$data.onSurface.color"
      >
        <div class="theme-name">{{$data.theme}} Mode</div>
        <div class="theme-color-container">
          <o-fill :value="$data.groups">
            <div class="theme-color-group">
              <o-fill :value="$data.blocks">
                <div
                  class="theme-color-block"
                  :style.background="$data.color"
                  :style.color="$data.fontColor"
                  on:click="$host.copyCssVar($data)"
                >
                  <o-if :value="$data.copySuccess">
                    <div class="theme-color-css-var">Copied</div>
                  </o-if>
                  <o-else>
                    <div class="theme-color-name">{{$data.name}}</div>
                    <div class="theme-color-css-var">{{$data.cssVar}}</div>
                  </o-else>
                </div>
              </o-fill>
            </div>
          </o-fill>
        </div>
        <div style="display: flex">
          <div
            class="theme-color-block"
            :style.background="$data.surface.color"
            :style.color="$data.onSurface.color"
            on:click="$host.copyCssVar($data.surface)"
          >
            <o-if :value="$data.surface.copySuccess">
              <div class="theme-color-css-var">Copied</div>
            </o-if>
            <o-else>
              <div class="theme-color-name">Surface</div>
              <div class="theme-color-css-var">{{$data.surface.cssVar}}</div>
            </o-else>
          </div>
          <div
            class="theme-color-block"
            :style.background="$data.onSurface.color"
            :style.color="$data.surface.color"
            on:click="$host.copyCssVar($data.onSurface)"
          >
            <o-if :value="$data.onSurface.copySuccess">
              <div class="theme-color-css-var">Copied</div>
            </o-if>
            <o-else>
              <div class="theme-color-name">On Surface</div>
              <div class="theme-color-css-var">{{$data.onSurface.cssVar}}</div>
            </o-else>
          </div>
        </div>
      </div>
    </o-fill>

    <h3>颜色</h3>
    <div class="color-container">
      <o-fill :value="colors">
        <div class="color-group" :style.border-color="$data.pick">
          <div class="color-name" :style.color="$data.pick">{{$data.name}}</div>
          <o-fill :value="$data.colors">
            <div
              class="color-block"
              :style.background="$data.color"
              :style.color="$host.getBlockColor($data)"
              on:click="$host.copyCssVar($data)"
            >
              <o-if :value="$data.copySuccess">
                <div>Copied</div>
              </o-if>
              <o-else> {{$data.point}} </o-else>
            </div>
          </o-fill>
        </div>
      </o-fill>
    </div>
  </div>
  <script>
    export const parent = "./layout.html";

    export default async ({ load }) => {
      const { Hct, getColors } = await load("../util/mcu-ts/index.js");

      return {
        data: {
          themes: [],
          colors: [],
        },
        proto: {
          copyCssVar(data) {
            navigator.clipboard.writeText(data.cssVar);
            data.copySuccess = true;
            setTimeout(() => {
              data.copySuccess = false;
            }, 500);
          },
          getBlockColor(item) {
            if (item.point > 50) {
              return "#000000";
            }
            return "#ffffff";
          },
          loadColor() {
            const colors = [
              {
                name: "primary",
                color: "#1a7bd1",
              },
              {
                name: "success",
                color: "#6b9e52",
              },
              {
                name: "error",
                color: "#fb4747",
              },
              {
                name: "normal",
                color: "#808080",
              },
            ];

            // 加载颜色
            colors.forEach((item) => {
              const colors = getColors(item.color, points);

              this.colors.push({
                name: item.name,
                pick: item.color,
                colors: colors.map((e, index) => {
                  return {
                    cssVar: `--md-ref-palette-${item.name}${points[index]}`,
                    color: e,
                    point: points[index],
                  };
                }),
              });
            });

            // 加载主题
            themes.forEach(({ themeName, names, ...other }) => {
              // 加载主题颜色
              const themeGroup = [];
              this.colors.forEach(({ colors, name: colorName }) => {
                const themeItem = {
                  name: colorName,
                  blocks: [],
                };

                themeGroup.push(themeItem);

                names.forEach(({ name, cssVar, num, reverseNum }) => {
                  const targetColorItem = colors.find((e) => e.point === num);
                  const reverseColorItem = colors.find(
                    (e) => e.point === reverseNum
                  );
                  themeItem.blocks.push({
                    name: name.replace(
                      "Main",
                      colorName.charAt(0).toUpperCase() + colorName.slice(1)
                    ),
                    cssVar: cssVar.replace("-main", "-" + colorName),
                    color: targetColorItem.color,
                    fontColor: this.getBlockColor(targetColorItem),
                  });
                });
              });

              // 计算surface颜色
              const normalColorItem = this.colors.find(
                (e) => e.name === "normal"
              );

              this.themes.push({
                theme: themeName.charAt(0).toUpperCase() + themeName.slice(1),
                groups: themeGroup,
                surface: {
                  cssVar: "--md-sys-color-surface",
                  color: normalColorItem.colors.find(
                    (e) => e.point === other.surface
                  ).color,
                },
                onSurface: {
                  cssVar: "--md-sys-color-on-surface",
                  color: normalColorItem.colors.find(
                    (e) => e.point === other.onSurface
                  ).color,
                },
              });
            });
          },
        },
        attached() {
          this.emit("active-page", {
            composed: true,
            data: { name: "color" },
          });

          this.loadColor();
        },
      };
    };

    const themes = [
      {
        themeName: "light",
        surface: 98,
        onSurface: 10,
        names: [
          {
            name: "Main",
            cssVar: "--md-sys-color-main",
            num: 40,
            reverseNum: 100,
          },
          {
            name: "On Main",
            cssVar: "--md-sys-color-on-main",
            num: 100,
            reverseNum: 40,
          },
          {
            name: "Main Container",
            cssVar: "--md-sys-color-main-container",
            num: 90,
            reverseNum: 10,
          },
          {
            name: "On Main Container",
            cssVar: "--md-sys-color-on-main-container",
            num: 10,
            reverseNum: 90,
          },
        ],
      },
      {
        themeName: "dark",
        surface: 6,
        onSurface: 90,
        names: [
          {
            name: "Main",
            cssVar: "--md-sys-color-main",
            num: 80,
            reverseNum: 20,
          },
          {
            name: "On Main",
            cssVar: "--md-sys-color-on-main",
            num: 20,
            reverseNum: 80,
          },
          {
            name: "Main Container",
            cssVar: "--md-sys-color-main-container",
            num: 30,
            reverseNum: 70,
          },
          {
            name: "On Main Container",
            cssVar: "--md-sys-color-on-main-container",
            num: 90,
            reverseNum: 70,
          },
        ],
      },
    ];

    const points = [100, 98, 95, 90, 80, 70, 60, 50, 40, 30, 20, 10, 6, 0];
  </script>
</template>
