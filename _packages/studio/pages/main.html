<template page>
  <!-- <l-m src="../comps/monaco-editor.html"></l-m> -->
  <style>
    :host {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .left {
      position: relative;
      /* width: 260px; */
      overflow: auto;
      border-right: 1px solid rgba(204, 204, 204, 0.2);
    }

    .left-resize-bar {
      position: absolute;
      top: 0;
      right: 0px;
      width: 5px;
      height: 100%;
      z-index: 6;
      cursor: col-resize;
    }

    .left-resize-bar:hover {
      background-color: rgba(38, 72, 174, 0.414);
    }

    .main {
      display: flex;
      flex-direction: column;
      position: relative;
      flex: 1;
    }
    .main-top {
      height: 36px;
      border-bottom: 1px solid rgba(204, 204, 204, 0.2);
    }
    .article {
      flex: 1;
    }
    .article.in-resize {
      pointer-events: none;
    }
  </style>
  <div class="left" style="width: 260px">
    <div class="left-resize-bar" on:mousedown="resizeLeftStart"></div>
    <o-page src="./file-explore.html"></o-page>
  </div>
  <div class="main">
    <div class="main-top">
      <o-page src="./content-top.html"></o-page>
    </div>
    <div class="article" class:in-resize="inResize">
      <div class="line-mask"></div>
      <o-page src="./content.html"></o-page>
    </div>
  </div>
  <o-consumer
    name="studio-data"
    watch:project-path="projectPath"
    watch:active-file="activeFilePath"
  ></o-consumer>
  <script>
    export const parent = "./layout.html";

    export default async ({ load }) => {
      return {
        data: {
          projectPath: "",
          activeFilePath: "",
          inResize: false,
        },
        proto: {
          resizeLeftStart(e) {
            e.preventDefault();
            this._resizeLeftStartX = e.clientX;
            const leftContainer = this.shadow.$(".left");
            this._startWidth = leftContainer.width;
            this.inResize = true;

            // 鼠标移动时，更新左侧宽度
            let resizeLeftMove;
            document.addEventListener(
              "mousemove",
              (resizeLeftMove = (e) => {
                const diffLeft = e.clientX - this._resizeLeftStartX;
                leftContainer.style.width = `${this._startWidth + diffLeft}px`;
              })
            );

            this._cancelResizeLeft = () => {
              document.removeEventListener("mousemove", resizeLeftMove);
              document.removeEventListener("mouseup", resizeLeftEnd);
              this.inResize = false;
              this._cancelResizeLeft = null;
            };

            // 鼠标松开时，移除事件监听
            let resizeLeftEnd;
            document.addEventListener(
              "mouseup",
              (resizeLeftEnd = () => {
                // 记录当前的宽度
                localStorage.setItem("editor_left_width", leftContainer.width);

                this._cancelResizeLeft();
              })
            );
          },
        },
        async attached() {
          if (localStorage.getItem("editor_left_width")) {
            this.shadow.$(".left").style.width =
              localStorage.getItem("editor_left_width") + "px";
          }
        },
        detached() {
          this._cancelResizeLeft && this._cancelResizeLeft();
        },
      };
    };
  </script>
</template>
