<template page>
  <style>
    :host {
      display: block;
      height: 100%;
    }

    .hide {
      display: none;
    }
  </style>
  <monaco-editor
    class:hide="mode !== 'edit'"
    style="width: 100%; height: 100%"
    plugins="prettier"
  ></monaco-editor>
  <o-if :value="mode === 'img'">
    <div
      style="
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        width: 100%;
      "
    >
      <img attr:src="picUrl" alt="" style="max-width: 80%; max-height: 80%" />
    </div>
  </o-if>

  <!-- <monaco-editor
    style="width: 100%; height: 100%"
    plugins="http://localhost:3002/_packages/editor/comps/plugins/prettier.js"
  ></monaco-editor> -->
  <o-consumer
    name="studio-data"
    watch:project-path="projectPath"
    watch:active-file="activeFilePath"
  ></o-consumer>
  <script>
    export default async ({ load }) => {
      await load("../comps/monaco-editor.html");
      const { getType } = await load("../util/get-type.js");
      const { get } = await load("/nos/fs/handle/main.js");

      return {
        data: {
          activeFilePath: "",
          mode: "edit",
          picUrl: "",
        },
        watch: {
          activeFilePath() {
            this.loadFile();
          },
        },
        proto: {
          async loadFile() {
            if (!this.activeFilePath) {
              this.shadow.$("monaco-editor").setValue("");
              return;
            }

            const targetHandle = await get(this.activeFilePath);

            if (targetHandle.kind === "file") {
              if (this.picUrl) {
                URL.revokeObjectURL(this.picUrl);
                this.picUrl = "";
              }

              // 判断是否图片
              if (isPic(this.activeFilePath)) {
                this.mode = "img";
                const file = await targetHandle.file();
                this.picUrl = URL.createObjectURL(file);
                return;
              }

              this.mode = "edit";

              const contenet = await targetHandle.text();
              this.shadow.$("monaco-editor").setValue(contenet);

              const type = getType(this.activeFilePath);
              this.shadow.$("monaco-editor").setLanguage(type);
            }
          },
        },
        async attached() {
          await this.shadow.$("monaco-editor")._initialized;
        },
        detached() {},
      };
    };

    const isPic = (path) => {
      const imgExts = [
        ".png",
        ".jpg",
        ".jpeg",
        ".gif",
        ".bmp",
        ".svg",
        ".webp",
        ".ico",
      ];
      return imgExts.some((ext) => path.toLowerCase().endsWith(ext));
    };
  </script>
</template>
