<template page>
  <l-m src="../comps/handle-icon.html"></l-m>
  <style>
    :host {
      display: block;
    }
    .container {
      display: flex;
    }
    .tab {
      position: relative;
      padding: 8px 6px 8px 12px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .close-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 2;
      width: 18px;
      height: 18px;
      margin-left: 8px;
      cursor: pointer;
      border-radius: 10px;
      opacity: 0;
    }

    .close-btn:hover {
      opacity: 1;
      background-color: rgba(114, 114, 114, 0.4);
    }

    .tab.focus {
      z-index: 3;
      background-color: #1e1e1e;
      cursor: default;
    }

    .active-mark {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 1px;
      background-color: #007acc;
    }

    .tab .active-mark {
      display: none;
    }
    .tab.focus .active-mark {
      display: block;
    }
    .italic {
      font-style: italic;
    }

    .alter-icon {
      display: none;
    }

    .tab.has-changed .close-btn {
      opacity: 1;
    }
    .tab.has-changed .alter-icon {
      display: block;
    }
    .tab.has-changed .close-btn .close-icon {
      display: none;
    }
  </style>
  <div class="container">
    <o-fill :value="list">
      <div
        class="tab"
        class:italic="!$data.permanent"
        on:mousedown="$host.clickItem($data)"
        class:focus="$data.path === $host.activeFilePath"
        class:has-changed="$host.hasChangedPaths.includes($data.path)"
      >
        <div class="active-mark"></div>
        <handle-icon :path="$data.path" style="margin-right: 4px;"></handle-icon>
        {{$data.name}}
        <div class="close-btn" on:click="$host.closeTab($data,$event,$index)">
          <n-icon
            icon="material-symbols:close-small-rounded"
            class="close-icon"
          ></n-icon>
          <n-icon
            icon="material-symbols:launcher-assistant-off"
            class="alter-icon"
          ></n-icon>
        </div>
      </div>
    </o-fill>
  </div>
  <o-consumer
    name="studio-data"
    watch:active-file="activeFilePath"
    watch:project-path="projectPath"
    on:dblclick-file="dblclickFile"
    on:save="saveFile"
  ></o-consumer>
  <script>
    export default async ({ load }) => {
      const { get } = await load("/nos/fs/handle/main.js");
      const { hasChangedPaths } = await load("./content.html");

      return {
        data: {
          activeFilePath: "",
          projectPath: "",
          hasChangedPaths: [],
          list: [],
        },
        watch: {
          activeFilePath() {
            this.changeActiveFile();
          },
          projectPath() {
            this.loadHistory();
          },
        },
        proto: {
          saveFile(e) {
            const { path, content } = e.data;

            // 将对应path的permanent设置为true
            const index = this.list.findIndex((item) => item.path === path);
            if (index !== -1) {
              this.list[index].permanent = true;
            }
          },
          async changeActiveFile() {
            if (!this.activeFilePath) {
              return;
            }

            // 判断路径是否是文件，如果不是则不需要添加
            const handle = await get(this.activeFilePath);
            if (handle.kind !== "file") return;

            // 如果不在列表中，添加到列表
            if (!this.list.some((item) => item.path === this.activeFilePath)) {
              // 判断是否有 permanent false，有则替换它
              const index = this.list.findIndex(
                (item) => item.permanent === false
              );

              if (index !== -1) {
                this.list[index] = {
                  name: this.activeFilePath.split("/").pop(),
                  path: this.activeFilePath,
                  permanent: false,
                };
              } else {
                this.list.push({
                  name: this.activeFilePath.split("/").pop(),
                  path: this.activeFilePath,
                  permanent: false,
                });
              }

              sessionStorage.setItem(
                "__studio_opened_tabs",
                JSON.stringify(this.list)
              );
            }
          },
          loadHistory() {
            if (!this.projectPath) return;

            let openedTabs = [];
            try {
              openedTabs =
                JSON.parse(sessionStorage.getItem("__studio_opened_tabs")) ||
                [];
            } catch (e) {}

            this.list = openedTabs;

            // 修正激活态
          },
          closeTab(item, event, index) {
            event.stopPropagation();

            if (index === 0 && this.list.length > 1) {
              // 切换到下一个
              this.clickItem(this.list[index + 1]);
              this.list.splice(0, 1);
              return;
            }

            if (this.list.length <= 1) {
              // 清空内容
              // this.activeFilePath = "";
              const provider = this.getProvider("studio-data");
              provider.activeFile = "";
              this.list = [];
              return;
            }

            // 如果是处于激活tab，切换到前一个
            if (item.path === this.activeFilePath) {
              const prevIndex = index === 0 ? index : index - 1;
              this.clickItem(this.list[prevIndex]);
            }

            this.list.splice(index, 1);

            // 保存到 sessionStorage
            sessionStorage.setItem(
              "__studio_opened_tabs",
              JSON.stringify(this.list)
            );
          },
          // 点击切换选中项
          clickItem(item) {
            const provider = this.getProvider("studio-data");
            provider.activeFile = item.path;
          },
          dblclickFile(e) {
            const { path } = e.data;

            // 已经存在的不重复添加
            if (this.list.some((item) => item.path === path)) {
              // 如果permanent为false，则修正为true
              const item = this.list.find((item) => item.path === path);
              if (item) {
                item.permanent = true;
              }
              return;
            }

            this.list.push({
              name: path.split("/").pop(),
              path,
              permanent: true,
            });

            // 保存到 sessionStorage
            sessionStorage.setItem(
              "__studio_opened_tabs",
              JSON.stringify(this.list)
            );
          },
        },
        attached() {
          this.hasChangedPaths = hasChangedPaths;
        },
        detached() {
          this.hasChangedPaths = [];
        },
      };
    };
  </script>
</template>
