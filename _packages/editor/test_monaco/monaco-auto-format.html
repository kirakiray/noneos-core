<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>自动格式化代码</title>
    <style>
      #container {
        height: 500px;
        border: 1px solid #ccc;
      }
      button {
        margin: 10px;
        padding: 8px 16px;
      }
    </style>
  </head>
  <body>
    <div>
      <select id="languageSelect">
        <option value="html">HTML</option>
        <option value="javascript">JavaScript</option>
        <option value="typescript">TypeScript</option>
        <option value="css">CSS</option>
        <option value="json">JSON</option>
      </select>
      <button id="formatBtn">自动格式化</button>
    </div>
    <div id="container"></div>

    <script type="module">
      import * as monaco from "https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/+esm";

      // 核心：动态获取 Monaco 语言对应的 Prettier 配置
      async function getPrettierConfigForLanguage(languageId) {
        // Prettier parser 与 Monaco 语言的映射
        const parserMap = {
          javascript: {
            parser: "babel",
            plugins: ["babel", "estree"],
            ext: ".js",
          },
          typescript: {
            parser: "typescript",
            plugins: ["typescript", "estree"],
            ext: ".ts",
          },
          html: { parser: "html", plugins: ["html"], ext: ".html" },
          css: { parser: "css", plugins: ["postcss"], ext: ".css" },
          json: { parser: "json", plugins: ["babel", "estree"], ext: ".json" },
          markdown: { parser: "markdown", plugins: ["markdown"], ext: ".md" },
        };

        // 自动识别：如果未知语言，尝试从文件扩展名推断
        let config = parserMap[languageId];
        if (!config) {
          // 降级：尝试自动检测或返回默认配置
          console.warn(
            `未找到语言 "${languageId}" 的 Prettier 配置，使用默认 JS 配置`
          );
          config = parserMap.javascript;
        }

        // 动态加载插件
        const prettier = await import(
          "https://unpkg.com/prettier@3.4.1/standalone.mjs"
        );
        const loadedPlugins = [];

        for (const pluginName of config.plugins) {
          const plugin = await import(
            `https://unpkg.com/prettier@3.4.1/plugins/${pluginName}.mjs`
          );
          loadedPlugins.push(plugin);
        }

        return {
          prettier,
          options: {
            parser: config.parser,
            plugins: loadedPlugins,
            tabWidth: 2,
            semi: true,
            singleQuote: true,
            printWidth: 80,
            embeddedLanguageFormatting: "auto", // 自动识别嵌入式代码
          },
        };
      }

      // 创建编辑器
      const editor = monaco.editor.create(
        document.getElementById("container"),
        {
          language: "html",
          theme: "vs-dark",
          tabSize: 2,
          insertSpaces: true,
          fontSize: 14,
          automaticLayout: true,
        }
      );

      editor.setValue(`<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>未格式化代码</title>
<style>
body{background:#f0f0f0;color:#333;}
.container{max-width:1200px;margin:0 auto;padding:20px;}
</style>
</head>
<body>
<div class="container">
<h1>测试自动格式化</h1>
<p>粘贴或输入混乱代码，会自动整理格式。</p>
<ul><li>项目1</li><li>项目2</li><li>项目3</li></ul>
</div>
</body>
</html>`);

      // 核心：注册通用格式化提供者（不过滤语言）
      monaco.languages.registerDocumentFormattingEditProvider(
        ["javascript", "typescript", "html", "css", "json"],
        {
          async provideDocumentFormattingEdits(model) {
            // 1. 自动识别当前语言
            const languageId = model.getLanguageId();
            console.log("自动识别语言:", languageId);

            try {
              // 2. 动态获取对应配置
              const { prettier, options } = await getPrettierConfigForLanguage(
                languageId
              );

              // 3. 格式化代码
              const formatted = await prettier.format(
                model.getValue(),
                options
              );

              // 4. 返回格式化结果
              return [
                {
                  range: model.getFullModelRange(),
                  text: formatted,
                },
              ];
            } catch (error) {
              console.error("格式化失败:", error);
              return []; // 返回空数组表示失败
            }
          },
        }
      );

      // 绑定格式化按钮
      document.getElementById("formatBtn").addEventListener("click", () => {
        editor.getAction("editor.action.formatDocument").run();
      });

      // 语言切换示例（自动识别会实时响应）
      document
        .getElementById("languageSelect")
        .addEventListener("change", (e) => {
          monaco.editor.setModelLanguage(editor.getModel(), e.target.value);
        });
    </script>
  </body>
</html>
