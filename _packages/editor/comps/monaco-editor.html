<template component>
  <style>
    :host {
      position: relative;
      display: block;
      height: 100%;
    }
    iframe {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
  <!-- <iframe src="./monaco-editor-inner.html?frameid=123" frameborder="0"></iframe> -->
  <script>
    export default async ({ load, url }) => {
      return {
        tag: "monaco-editor",
        data: {
          _frame: null,
          _frameid: null,
          _inited: null,
        },
        proto: {
          async setValue(value) {
            await this._inited;

            this._frame.contentWindow.postMessage(
              {
                type: "setValue",
                value,
              },
              "*"
            );
          },
        },
        ready() {
          this._inited = new Promise((resolve, reject) => {
            window.addEventListener("message", (e) => {
              if (e.data.id === this._frameid && e.data.inited) {
                // 初始化完成
                resolve();
              }
            });
          });

          this._frameid = Math.random().toString(36).slice(2);

          this.shadow.push(
            `<iframe src="${new URL(
              "./monaco-editor-inner.html",
              url
            )}?frameid=${this._frameid}" frameborder="0"></iframe>`
          );

          this._frame = this.shadow.$("iframe").ele;
        },
        attached() {
          this.setValue(`<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>未格式化代码</title>
<style>
body{background:#f0f0f0;color:#333;}
.container{max-width:1200px;margin:0 auto;padding:20px;}
</style>
</head>
<body>
<div class="container">
<h1>测试自动格式化</h1>
<p>粘贴或输入混乱代码，会自动整理格式。</p>
<ul><li>项目1</li><li>项目2</li><li>项目3</li></ul>
</div>
</body>
</html>`);
        },
      };
    };
  </script>
</template>
