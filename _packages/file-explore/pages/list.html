<template page>
  <style>
    :host {
      display: block;
    }
    .container {
      width: 100%;
      height: 100%;
    }

    .list {
      display: flex;
      flex-wrap: wrap;
      padding: 8px;
    }

    .item {
      cursor: pointer;
      padding: 8px;
      margin: 8px;
      border-radius: 4px;
    }
    .item:hover {
      background-color: #f5f5f5;
    }
  </style>
  <div class="container">
    <div class="header">
      <div class="title">{{path}}</div>
    </div>
    <div class="list">
      <o-fill :value="list">
        <div class="item" on:click="$host.handleClick($data)">
          {{$data.name}}
        </div>
      </o-fill>
    </div>
  </div>
  <script>
    export default async ({ load, query }) => {
      const currentPath = query.path || "/";

      return {
        data: {
          path: currentPath,
          list: [],
        },
        proto: {
          async handleClick(data) {
            this.goto(`./list.html?path=${data.path}`);
          },
          async loadFile() {
            const rootHandle = await navigator.storage.getDirectory();
            let currentHandle = rootHandle;

            if (currentPath !== "/") {
              let paths = currentPath.split("/");
              paths = paths.filter((item) => item !== "");
              for (const path of paths) {
                currentHandle = await currentHandle.getDirectoryHandle(path);
              }
            }

            for await (const entry of currentHandle.values()) {
              this.list.push({
                name: entry.name,
                type: entry.kind,
                path:
                  currentPath === "/"
                    ? `/${entry.name}`
                    : `${currentPath}/${entry.name}`,
              });
            }
          },
        },
        attached() {
          this.loadFile();
        },
      };
    };
  </script>
</template>
