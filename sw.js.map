{"version":3,"file":"sw.js","sources":["sw/fs.js","sw/get-by-platform.js","sw/main.js"],"sourcesContent":["let rootHandle = null;\n\n// 获取根目录句柄\nexport const getRoot = async () => {\n  if (!rootHandle) {\n    rootHandle = await navigator.storage.getDirectory();\n  }\n\n  return rootHandle;\n};\n\n// 获取文件句柄\nexport const getFileHandle = async ({ path, create }) => {\n  const rootHandle = await getRoot();\n\n  const paths = path.split(\"/\");\n  if (paths[0] === \"\") {\n    paths.shift();\n  }\n\n  let currentHandle = rootHandle;\n  let lastName = paths[paths.length - 1];\n  for (const p of paths) {\n    if (p === lastName) {\n      break;\n    }\n    currentHandle = await currentHandle.getDirectoryHandle(p, { create });\n  }\n\n  const fileHandle = await currentHandle.getFileHandle(lastName, { create });\n\n  return fileHandle;\n};\n\n// 获取目录句柄\nexport const getDirHandle = async ({ path, create }) => {\n  const rootHandle = await getRoot();\n  const dirHandle = await rootHandle.getDirectoryHandle(path, { create });\n  \n  return dirHandle;\n};\n","import { getFileHandle } from \"./fs.js\";\n\n// 从 GitHub 仓库获取文件\nexport const getByGh = async ({ path }) => {\n  const rePath = path.replace(/^\\/_gh\\//, \"https://cdn.jsdelivr.net/gh/\");\n  // const rePath = path.replace(/^\\/_gh\\//, \"https://cdn.statically.io/gh/\");\n\n  console.log(\"gh: \", rePath);\n\n  let targetHandle = await getFileHandle({ path }).catch(() => null);\n\n  if (targetHandle) {\n    const fileStream = await targetHandle.getFile();\n    if (fileStream.size) {\n      return new Response(fileStream);\n    }\n  }\n\n  // 请求实际文件\n  const response = await fetch(rePath);\n  const blob = await response.blob();\n\n  // 写入缓存\n  targetHandle = await getFileHandle({ path, create: true });\n  const writeStream = await targetHandle.createWritable();\n  await writeStream.write(blob);\n  await writeStream.close();\n\n  // 转化为新的 Response 对象\n  return new Response(blob);\n};\n","import { getByGh } from \"./get-by-platform.js\";\n\nself.addEventListener(\"fetch\", (event) => {\n  const { request } = event;\n  const { pathname } = new URL(request.url);\n\n  console.log(\"pathname: \", pathname);\n\n  if (/^\\/_gh\\//.test(pathname)) {\n    // 从 GitHub 仓库获取文件\n    return event.respondWith(\n      getByGh({\n        path: pathname,\n        originUrl: request.url,\n      })\n    );\n  }\n\n  if (/^\\/_/.test(pathname)) {\n    // 隐藏目录开头的，属于本地文件，无需代理\n    return;\n  }\n});\n\nself.addEventListener(\"install\", () => {\n  self.skipWaiting();\n  console.log(\"NoneOS installation successful\");\n});\n\nself.addEventListener(\"activate\", () => {\n  self.clients.claim();\n  console.log(\"NoneOS server activation successful\");\n});\n"],"names":[],"mappings":"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"}