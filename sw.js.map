{"version":3,"file":"sw.js","sources":["sw/fs.js","sw/util.js","sw/get-by-platform.js","sw/main.js"],"sourcesContent":["let rootHandle = null;\n\n// 获取根目录句柄\nexport const getRoot = async () => {\n  if (!rootHandle) {\n    rootHandle = await navigator.storage.getDirectory();\n  }\n\n  return rootHandle;\n};\n\n// 获取文件句柄\nexport const getFileHandle = async ({ path, create }) => {\n  const rootHandle = await getRoot();\n\n  const paths = path.split(\"/\");\n  if (paths[0] === \"\") {\n    paths.shift();\n  }\n\n  let currentHandle = rootHandle;\n  let lastName = paths[paths.length - 1];\n  for (const p of paths) {\n    if (p === lastName) {\n      break;\n    }\n    currentHandle = await currentHandle.getDirectoryHandle(p, { create });\n  }\n\n  const fileHandle = await currentHandle.getFileHandle(lastName, { create });\n\n  return fileHandle;\n};\n\n// 获取目录句柄\nexport const getDirHandle = async ({ path, create }) => {\n  const rootHandle = await getRoot();\n  const dirHandle = await rootHandle.getDirectoryHandle(path, { create });\n  \n  return dirHandle;\n};\n","export const getContentType = (path) => {\n  const prefix = path.split(\".\").slice(-1)[0];\n\n  switch (prefix) {\n    case \"html\":\n    case \"htm\":\n    case \"txt\":\n    case \"md\":\n      return \"text/plain; charset=utf-8\";\n    case \"js\":\n    case \"mjs\":\n      return \"application/javascript; charset=utf-8\";\n    case \"json\":\n      return \"application/json; charset=utf-8\";\n    case \"css\":\n      return \"text/css; charset=utf-8\";\n    case \"xml\":\n      return \"application/xml; charset=utf-8\";\n    case \"svg\":\n      return \"image/svg+xml; charset=utf-8\";\n    case \"csv\":\n      return \"text/csv; charset=utf-8\";\n    case \"ics\":\n      return \"text/calendar; charset=utf-8\";\n    case \"pdf\":\n      return \"application/pdf; charset=utf-8\";\n    case \"doc\":\n    case \"docx\":\n      return \"application/msword; charset=utf-8\";\n    case \"xls\":\n    case \"xlsx\":\n      return \"application/vnd.ms-excel; charset=utf-8\";\n    case \"ppt\":\n    case \"pptx\":\n      return \"application/vnd.ms-powerpoint; charset=utf-8\";\n    case \"zip\":\n      return \"application/zip; charset=utf-8\";\n    case \"gz\":\n      return \"application/gzip; charset=utf-8\";\n    case \"tar\":\n      return \"application/x-tar; charset=utf-8\";\n    case \"jpg\":\n    case \"jpeg\":\n      return \"image/jpeg\";\n    case \"png\":\n      return \"image/png\";\n    case \"gif\":\n      return \"image/gif\";\n    case \"bmp\":\n      return \"image/bmp\";\n    case \"ico\":\n      return \"image/x-icon\";\n    case \"webp\":\n      return \"image/webp\";\n    case \"bmp\":\n      return \"image/bmp\";\n    case \"mp3\":\n      return \"audio/mpeg\";\n    case \"wav\":\n      return \"audio/wav\";\n    case \"mp4\":\n    case \"m4v\":\n      return \"video/mp4\";\n    case \"mov\":\n      return \"video/quicktime\";\n    case \"avi\":\n      return \"video/x-msvideo\";\n    default:\n      return \"application/octet-stream\";\n  }\n};\n","import { getFileHandle } from \"./fs.js\";\nimport { getContentType } from \"./util.js\";\n\n// 从 GitHub 仓库获取文件\nexport const getByGh = async ({ path }) => {\n  const rePath = path.replace(/^\\/_gh\\//, \"https://cdn.jsdelivr.net/gh/\");\n  // const rePath = path.replace(/^\\/_gh\\//, \"https://cdn.statically.io/gh/\");\n\n  console.log(\"gh: \", rePath);\n\n  let targetHandle = await getFileHandle({ path }).catch(() => null);\n\n  if (targetHandle) {\n    const fileStream = await targetHandle.getFile();\n    if (fileStream.size) {\n      return new Response(fileStream, {\n        headers: {\n          \"Content-Type\": getContentType(path),\n        },\n      });\n    }\n  }\n\n  // 请求实际文件\n  const response = await fetch(rePath);\n  const blob = await response.blob();\n\n  // 写入缓存\n  targetHandle = await getFileHandle({ path, create: true });\n  const writeStream = await targetHandle.createWritable();\n  await writeStream.write(blob);\n  await writeStream.close();\n\n  // 转化为新的 Response 对象\n  return new Response(blob, {\n    headers: {\n      \"Content-Type\": getContentType(path),\n    },\n  });\n};\n","import { getByGh } from \"./get-by-platform.js\";\n\nself.addEventListener(\"fetch\", (event) => {\n  const { request } = event;\n  const { pathname } = new URL(request.url);\n\n  console.log(\"pathname: \", pathname);\n\n  try {\n    if (/^\\/_gh\\//.test(pathname)) {\n      // 从 GitHub 仓库获取文件\n      return event.respondWith(\n        getByGh({\n          path: pathname,\n          originUrl: request.url,\n        })\n      );\n    }\n  } catch (err) {\n    return new Response(err.stack || err.toString(), {\n      status: 400,\n    });\n  }\n\n  if (/^\\/_/.test(pathname)) {\n    // 隐藏目录开头的，属于本地文件，无需代理\n    return;\n  }\n});\n\nself.addEventListener(\"install\", () => {\n  self.skipWaiting();\n  console.log(\"NoneOS installation successful\");\n});\n\nself.addEventListener(\"activate\", () => {\n  self.clients.claim();\n  console.log(\"NoneOS server activation successful\");\n});\n"],"names":[],"mappings":"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"}