/* version: 4.0.4 */
!function(){"use strict";let e=null;const t=async()=>(e||(e=await navigator.storage.getDirectory()),e),s=async({path:e,create:s})=>{const a=await t(),n=e.split("/");""===n[0]&&n.shift();let r=a,c=n.length-1;for(let e=0;e<c&&e!=c;e++){const t=n[e];r=await r.getDirectoryHandle(t,{create:s})}return await r.getFileHandle(n[n.length-1],{create:s})},a=e=>{switch(e.split(".").slice(-1)[0]){case"html":case"htm":return"text/html; charset=utf-8";case"txt":case"md":return"text/plain; charset=utf-8";case"js":case"mjs":return"application/javascript; charset=utf-8";case"json":return"application/json; charset=utf-8";case"css":return"text/css; charset=utf-8";case"xml":return"application/xml; charset=utf-8";case"svg":return"image/svg+xml; charset=utf-8";case"csv":return"text/csv; charset=utf-8";case"ics":return"text/calendar; charset=utf-8";case"pdf":return"application/pdf; charset=utf-8";case"doc":case"docx":return"application/msword; charset=utf-8";case"xls":case"xlsx":return"application/vnd.ms-excel; charset=utf-8";case"ppt":case"pptx":return"application/vnd.ms-powerpoint; charset=utf-8";case"zip":return"application/zip; charset=utf-8";case"gz":return"application/gzip; charset=utf-8";case"tar":return"application/x-tar; charset=utf-8";case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"gif":return"image/gif";case"bmp":case"bmp":return"image/bmp";case"ico":return"image/x-icon";case"webp":return"image/webp";case"mp3":return"audio/mpeg";case"wav":return"audio/wav";case"mp4":case"m4v":return"video/mp4";case"mov":return"video/quicktime";case"avi":return"video/x-msvideo";default:return e.split("/").slice(-1)[0].includes("esm")?"application/javascript; charset=utf-8":"application/octet-stream"}};let n=null;const r=async e=>{const t=await(async()=>n||new Promise(e=>{const t=indexedDB.open("handles-db",1);t.onupgradeneeded=()=>t.result.createObjectStore("handles",{keyPath:"id"}),t.onsuccess=()=>{n=t.result,e(t.result)},t.onerror=e=>{n=null},t.onblocked=()=>{n=null}}))();return new Promise((s,a)=>{const n=t.transaction("handles").objectStore("handles").get(e);n.onsuccess=e=>{const t=e.target.result;s(t?t.handle:null)},n.onerror=()=>{a(n.error)}})};let c={};self.addEventListener("fetch",e=>{const{request:t}=e,{pathname:n}=new URL(t.url);if("/__version"===n)return e.respondWith(new Response("noneos-core@4.0.4".replace("noneos-core@","")));if("/__config"===n)return e.respondWith(o());try{if(globalThis?.SERVER_OPTIONS?.useNosTool&&/^\/nos-tool\//.test(n))return e.respondWith((async({request:e})=>{const t=location.host;if("localhost:3002"===t)return fetch(e);if(/^localhost:/.test(t)){const t=e.url.replace(/:(\d+)/,":3002");try{return await fetch(t)}catch{return await fetch(e.url)}}const s=e.url.replace(/^https?:\/\/[^\/]+\//,"");return fetch(`https://core.noneos.com/${s}`)})({path:n,request:t,systemConfig:c}));if(/^\/nos\//.test(n))return e.respondWith((async({path:e,request:t,systemConfig:n})=>{if(!n||!n.mode||"online"===n.mode)return fetch(t);if("local"===n.mode)try{const r=e.replace(/^\/nos\//,n.nosMapPath+"/");let c=await s({path:r}).catch(()=>null);if(c){const t=await c.getFile();if(t.size)return new Response(t,{headers:{"Content-Type":a(e)}})}return fetch(t)}catch(e){return fetch(t)}})({path:n,request:t,systemConfig:c}));if(/^\/gh\//.test(n))return e.respondWith((async({path:e})=>{const t=e.replace(/^\/gh\//,"https://cdn.jsdelivr.net/gh/");let n=await s({path:e}).catch(()=>null);if(n){const t=await n.getFile();if(t.size)return new Response(t,{headers:{"Content-Type":a(e)}})}const r=await fetch(t),c=await r.blob();n=await s({path:e,create:!0});const o=await n.createWritable();return await o.write(c),await o.close(),new Response(c,{headers:{"Content-Type":a(e)}})})({path:n,originUrl:t.url,systemConfig:c}));if(/^\/npm\//.test(n))return e.respondWith((async({path:e})=>{const t=e.replace(/^\/npm\//,"https://cdn.jsdelivr.net/npm/");console.log("npm request: ",t);let n=await s({path:e}).catch(()=>null);if(n){const t=await n.getFile();if(t.size){const s=t.type||a(e);return new Response(t,{headers:{"Content-Type":s}})}}try{const r=await fetch(t);if(!r.ok)throw new Error(`Failed to fetch ${t}: ${r.status} ${r.statusText}`);const c=await r.blob();n=await s({path:e,create:!0});const o=await n.createWritable();await o.write(c),await o.close();const i=c.type||a(e);return new Response(c,{headers:{"Content-Type":i}})}catch(e){return console.error("Error fetching npm package:",e),new Response(`Error fetching npm package: ${e.message}`,{status:500,headers:{"Content-Type":"text/plain; charset=utf-8"}})}})({path:n,originUrl:t.url,systemConfig:c}));if(/^\/\$mount-/.test(n))return e.respondWith((async({path:e,originUrl:t})=>{let s=decodeURIComponent(e);/\/$/.test(e)&&(s+="index.html");const n=s.replace(/\/\$mount\-(.+)>.+/,"$1"),c=s.split("/").slice(2);try{const e=await r(n);if(!e)throw new Error(`Mounted ID ${n} not found`);let t=e;for(let e=0;e<c.length;e++){let s=c[e];e===c.length-1?(""===s&&(s="index.html"),t=await t.getFileHandle(s)):t=await t.getDirectoryHandle(s)}const o=s.split(".").pop();return new Response(await t.getFile(),{status:200,headers:{"Content-Type":a(o)}})}catch(e){return new Response(e.stack||e.toString(),{status:400})}})({path:n,originUrl:t.url,systemConfig:c}));if(/^\/\$/.test(n))return e.respondWith((async({path:e})=>{const t=e.replace(/^\/\$/,""),n=await s({path:t}).catch(()=>null);if(n){const t=await n.getFile();if(t.size)return new Response(t,{headers:{"Content-Type":a(e)}})}return new Response("Not Found",{status:404,headers:{"Content-Type":a(e)}})})({path:n,originUrl:t.url,systemConfig:c}))}catch(e){return new Response(e.stack||e.toString(),{status:400})}/^\/_/.test(n)}),self.addEventListener("install",()=>{self.skipWaiting(),console.log("NoneOS installation successful")}),self.addEventListener("activate",()=>{self.clients.claim(),console.log("NoneOS server activation successful"),setTimeout(()=>{o()},1e3)});const o=async()=>{try{const e=await navigator.storage.getDirectory(),t=await e.getDirectoryHandle("nos-config"),s=await t.getFileHandle("system.json"),a=await s.getFile(),n=await a.text();return n&&(c=JSON.parse(n)),new Response(JSON.stringify(c))}catch(e){return console.error("Reload system config failed:",e),new Response("Reload failed: "+(e.message||e),{status:500})}}}();
//# sourceMappingURL=dist.js.map
